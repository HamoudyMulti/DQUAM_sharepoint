<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css">

<script src="/sites/DQ/_catalogs/masterpage/DQUAM/DQUAM Configs/DQUAM Configs/JS/policy-common-functions.js"></script>
<link rel="stylesheet"
    href="/sites/DQ/_catalogs/masterpage/DQUAM/DQUAM Configs/DQUAM Configs/CSS/policy-common-stylesheet.css">


<div class="content">
    <div id="loader-policy" class="loader-policy"></div>


    <div class="row">
        <div class="col">
            <h5 class="fs-0 pt-2 pb-3 d-lg-none">Policy &amp; Procedure Request</h5>
        </div>
    </div>


    <!-- ################################### Inner Contents ################################ -->

    <div class="content-inner p-lg-4">
        <!-- BreadCrumb-->
        <div class="row mb-3 mb-xl-4">
            <div class="col">
                <nav style="--falcon-breadcrumb-divider: 'Â»';" aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a
                                href="https://mgskw.sharepoint.com/sites/DQ/Pages/gaps-dash.aspx">Quality
                                Documentation</a></li>
                        <li class="breadcrumb-item active"><a href="#">Policy &amp; Procedure Request</a></li>
                    </ol>
                </nav>
            </div>
        </div>

        <!-- Details/History tabs -->
        <div class="row align-items-center justify-content-between mb-3 mb-xl-4">
            <div class="col-12 col-xl-auto mb-2 mb-xl-0">
                <div class="btn-group btn-group-sm" role="group">
                    <a href="https://mgskw.sharepoint.com/sites/DQ/Pages/policy-request-readonly.aspx"
                        class="btn btn-dquam-primary" role="button">Details</a>
                    <a href="https://mgskw.sharepoint.com/sites/DQ/Pages/policy-request-history.aspx"
                        class="btn btn-outline-secondary" role="button">History</a>
                </div>
            </div>
            <div class="col-12 col-xl-auto">
                <div class="row g-2">
                    <div class="col-auto">
                        <button id="open_ms_team_button" class="btn btn-dquam-info btn-sm" type="button" disabled>Open
                            MS Team</button>
                    </div>
                    <div id="publish_list_modal" class="col-auto">

                    </div>
                </div>
            </div>
        </div>

        <!-- ============ page contents here... =========== -->

        <div class="card p-0 mb-4">
            <div class="card-body p-xl-3">

                <div class="row">
                    <div class="col">
                        <div class="theme-wizard theme-wizard-common-style">
                            <ul class="nav justify-content-between nav-wizard">
                                <li class="nav-item">
                                    <a class="nav-link fw-semi-bold done">
                                        <span class="nav-item-circle-parent">
                                            <span class="nav-item-circle">
                                                <span class="fas fa-hourglass-end"></span>
                                            </span>
                                        </span>
                                        <span class="d-none d-md-block mt-1 fs--1">Request Approval</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link fw-semi-bold done">
                                        <span class="nav-item-circle-parent">
                                            <span class="nav-item-circle">
                                                <span class="fas fa-magic"></span>
                                            </span>
                                        </span>
                                        <span class="d-none d-md-block mt-1 fs--1">Under Preparation</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link fw-semi-bold done">
                                        <span class="nav-item-circle-parent">
                                            <span class="nav-item-circle">
                                                <span class="fas fa-hourglass-end"></span>
                                            </span>
                                        </span>
                                        <span class="d-none d-md-block mt-1 fs--1">Stakeholders Approval</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link fw-semi-bold done">
                                        <span class="nav-item-circle-parent">
                                            <span class="nav-item-circle">
                                                <span class="fas fa-hourglass-end"></span>
                                            </span>
                                        </span>
                                        <span class="d-none d-md-block mt-1 fs--1">Regulators Approval</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link fw-semi-bold active">
                                        <span class="nav-item-circle-parent">
                                            <span class="nav-item-circle">
                                                <span class="fas fa-location-arrow"></span>
                                            </span>
                                        </span>
                                        <span class="d-none d-md-block mt-1 fs--1">Publish</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link fw-semi-bold">
                                        <span class="nav-item-circle-parent">
                                            <span class="nav-item-circle">
                                                <span class="fas fa-check"></span>
                                            </span>
                                        </span>
                                        <span class="d-none d-md-block mt-1 fs--1">Completed</span>
                                    </a>
                                </li>
                            </ul>
                        </div><!--End: theme-wizard -->
                    </div>
                </div>

            </div><!--End: card-body -->
        </div><!--End: card -->

        <div class="card">
            <div class="card-body p-xl-5">
                <div class="col-12 policy-status-top-div">
                    <span id="policy_status_top"
                        class="policy-status-top-presentation badge rounded p-2 minw-80"></span>
                </div>

                <br>
                <div class="row justify-content-end mb-3">
                    <div class="col-auto">
                        <button id="view_file" onclick="open_doc_new_tab($(this).data('file-url'))"
                            class="btn btn-dquam-info" type="button">
                            <span class="fas fa-file"></span>
                            <span class="ms-1">View File</span>
                        </button>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label text-900 fs-0 mb-1">Policy &amp; Procedure Title</label>
                    </div>
                    <div class="col-12">
                        <span id="policy_title" class="fs--1 text-600"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label text-900 fs-0 mb-1">Policy &amp; Procedure Description</label>
                    </div>
                    <div class="col-12">
                        <span id="policy_description" class="fs--1 text-600"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label text-900 fs-0 mb-1">Supporting Documents</label>
                    </div>
                    <div class="col-12">
                        <div id="policy_docs" class="d-flex flex-column777 flex-wrap">

                        </div>
                    </div>
                </div>
                <div class="row justify-content-between">
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label text-900 fs-0 mb-1">Status</label>
                            </div>
                            <div class="col-12">
                                <span id="policy_status" class="badge rounded p-2 minw-80"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label text-900 fs-0 mb-1">Revision Number</label>
                            </div>
                            <div class="col-12">
                                <span id="policy_revision_number" class="fs--1 text-600"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label text-900 fs-0 mb-1">Next Revision Date</label>
                            </div>
                            <div class="col-12">
                                <span id="policy_revision_date" class="fs--1 text-600"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label text-900 fs-0 mb-1">Publishing Date</label>
                            </div>
                            <div class="col-12">
                                <span id="policy_publishing_date" class="fs--1 text-600"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!--End: card -->

    </div><!-- End: content-inner -->

</div><!-- End: content -->



<script>
    let selected_users = [];
    let debounceTimer;
    let users_class = 'users-selection';

    let existing_users = [];

    $(document).ready(async function () {
        try {
            const record_id = get_CNID_from_url();

            let current_user = get_current_user_id();

            console.log("current_user", current_user)

            let selected_policy = await get_policy_info(record_id, "$select=*,Author/Id", "$expand=Author");

            let approvers_list = await get_approvers_list(record_id, null);

            let step_number = selected_policy.Step_Number;

            step_number_check(step_number, [5]);



            let access = await check_user_access(record_id, selected_policy, current_user, approvers_list);
            if (access == 'unauthorized') {
                redirect_user_to_home_page();
                return;
            }
            console.log("access", access);



            let permission = check_user_permissions(access, step_number);
            if (permission == 'none') {
                redirect_user_to_home_page();
                return;
            }
            console.log("permission", permission);


            create_people_picker_modal();

            modify_page_details();
            await populate_fields(selected_policy, record_id);
            apply_permissions(permission);




            on_click_close_modal();

            on_keydown_users_search();
            on_input_users_search();

            on_click_save_buttons();




        } catch (error) {
            console.error(error);
        }
    });

    function on_click_save_buttons() {
        $('#save_and_add_more_button, #save_and_exit_button').on('click', function () {

            let user = $('#selected_user');

            const user_id = user.attr('data-user-id');
            const title = user.attr('data-title');
            const email = user.attr('data-email');
            const image = user.attr('data-image');

            if (user_id) {
                selected_users.push({
                    user_id,
                    title,
                    email,
                    image
                });


                populate_selected_users();

                choice_select_remove();

                depopulate_users_modal();
                $('#users_search').val('');
            }

        });

        $('#save_and_exit_button').on('click', function () {
            $('#modal-policy-request4-publish').modal('hide');
        });

    }

    function populate_selected_users_box() {
        $(".selected_users_final_list").html("");
        let html = ``;

        selected_users.forEach(item => {
            html += `
                <div class="dropdown-item px-x1 py-2 selected-user-${item.user_id}">
                    <div class="row align-items-center g-3">
                        <div class="col">
                            <div class="d-flex align-items-center">
                                <div class="avatar avatar-l me-2">
                                    <img class="rounded-circle"
                                        src="${item.image}" alt="" />
                                </div>
                                <div class="flex-1">
                                    <h6 class="mb-0">${item.title}</h6>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div onclick="remove_selected_user('${item.user_id}')" class="btn-close-falcon text-danger">
                            </div>
                        </div>
                    </div>
                </div>
            `
        });

        $(".selected_users_final_list").html(html);
    }

    function populate_selected_users_box_details() {
        $(".selected_users_avatar_list").html("");
        let html = ``;


        for (let i = 0; i < Math.min(2, selected_users.length); i++) {
            const item = selected_users[i];

            html += `
            <div
                class="avatar avatar-xl border border-3 border-light rounded-circle">
                <img class="rounded-circle"
                    src="${item.image}" alt="" />
            </div>
            `;
        }

        if (selected_users.length > 2) {
            const remaining_count = selected_users.length - 2 + 1;

            html += `
                <div
                    class="avatar avatar-xl border border-3 border-light rounded-circle">
                    <div class="avatar-name rounded-circle">
                        <span>+${remaining_count}</span>
                    </div>
                </div>
            `;
        }

        $(".selected_users_avatar_list").html(html);
    }


    function populate_selected_users() {
        populate_selected_users_box();
        populate_selected_users_box_details();
    }

    function remove_selected_user(user_id) {
        selected_users = selected_users.filter(user => user.user_id != user_id);
        $(`.selected-user-${user_id}`).remove();
        populate_selected_users_box_details();


    }

    function choice_select_remove() {
        let html = `
            <div id="selected_user" class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <span class="mb-0 title">Select User</span>
                </div>
                <span class="fas fa-chevron-down text-600 fs--1 mx-2"></span>
            </div>
        `;

        $(".choice_select_user").html(html);
    }

    function capitalize_words(str) {
        return str.replace(/\b\w/g, function (match) {
            return match.toUpperCase();
        });
    }

    function get_active_directory_users_search(value) {
        let selected_users_filter = ``;

        selected_users.forEach(item => {
            if (selected_users_filter) {
                selected_users_filter += ' and ';
            }
            selected_users_filter += `id ne ${item.user_id}`

        });


        return new Promise(function (resolve, reject) {
            let select = "$select=ID,Title,Email";
            let filter = `$filter=
                PrincipalType eq 1
                and 
                ( substringof('${value}', Title) or substringof('${capitalize_words(value)}', Title) )
            `;

            if (selected_users_filter) {
                filter += ` and (${selected_users_filter})`;
            }


            $.ajax({
                url: _spPageContextInfo.webAbsoluteUrl + `/_api/web/siteusers?${select}&${filter}`,
                method: "GET",
                headers: {
                    "ACCEPT": "application/json; odata=verbose",
                },
                success: function (data) {
                    resolve(data.d.results);
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }




    function on_click_close_modal() {
        $('#closeModalButton').on('click', function (event) {
            event.preventDefault();
        });
    }

    function on_input_users_search() {
        $('#users_search').on('input', async function () {
            clearTimeout(debounceTimer);

            let value = $(this).val();


            depopulate_users_modal();

            debounceTimer = setTimeout(async function () {
                if (value.length >= 1) { // can be set to 2 characters or more
                    let users = await get_active_directory_users_search(value);
                    populate_users_modal(users);
                }
            }, 700);

        });

    }

    function populate_users_modal(users) {
        let html = ``;


        users.forEach(item => {
            const user_id = item.Id;
            const title = item.Title
            const email = item.Email;
            const image = _spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?size=S&accountname=' + item.Email;


            html += `
            <button type="button" onclick="choice_select_replace('${user_id}','${title}','${email}','${image}')" class="dropdown-item px-x1 py-2 ${users_class}">
                <div class="d-flex align-items-center">
                    <div class="avatar avatar-l status-online me-2">
                        <img class="rounded-circle"
                            src="${image}" alt="" />
                    </div>
                    <div class="flex-1">
                        <h6 class="mb-0 search-filter-data">
                            ${title}
                        </h6>
                    </div>
                </div>
            </button>
            `
        });

        $("#users_select").append(html);


    }

    function choice_select_replace(user_id, title, email, image) {

        $(".choice_select_user").html("");

        let html = `
            <div id="selected_user" class="d-flex align-items-center justify-content-between"
             data-user-id="${user_id}" 
             data-title="${title}" 
             data-email="${email}" 
             data-image="${image}"
            >
                <div class="d-flex align-items-center">
                    <div class="avatar avatar-l me-2">
                        <img class="rounded-circle" src="${image}" alt="" />
                    </div>
                    <span class="mb-0 title">${title}</span>
                </div>
                <span class="fas fa-chevron-down text-600 fs--1 mx-2"></span>
            </div>
        `;

        $(".choice_select_user").html(html);

        $('.choice_select_user').dropdown('hide');

    }

    function depopulate_users_modal() {
        $(`.${users_class}`).remove();
    }


    function on_keydown_users_search() {
        $('#users_search').on('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
            }
        });
    }

    function create_people_picker_modal() {
        let people_picker_basic_html = get_people_picker_html();
        $("#publish_list_modal").html(people_picker_basic_html);


    }

    function get_people_picker_html() {
        return `
        <button id="publishing_list_button" class="btn btn-dquam-primary btn-sm" type="button" data-bs-toggle="modal"
    data-bs-target="#modal-policy-request4-publish" disabled>Publish</button>
<div class="modal fade" id="modal-policy-request4-publish" tabindex="-1" role="dialog" aria-hidden="true"
    data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 400px">
        <div class="modal-content position-relative">
            <div class="position-absolute top-0 end-0 mt-2 me-2 z-1">
                <button id="closeModalButton" class="btn-close btn btn-sm btn-circle d-flex flex-center transition-base"
                    data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="rounded-top-3 py-3 ps-4 pe-6 bg-light">
                    <h6 class="mb-0 text-primary fs-0 fw-semi-bold text-900">Publishing List</h6>
                </div>
                <div class="p-4 pb-0 text-center">
                    <div>
                        <div class="mb-3">
                            <h6 class="mb-0 text-600">Select user or group:</h6>
                        </div>
                        <div class="mb-4">
                            <div class="col-12 mb-3">
                                <div class="border bg-white rounded p-3">
                                    <div class="row align-items-center justify-content-center g-2 mb-3">
                                        <div class="col-auto">
                                            <div class="dropdown dropdown-with-avatars font-sans-serif position-static">
                                                <button class="btn dropdown-toggle border border-0"
                                                    id="dropdownMenuButton2" type="button" data-bs-toggle="dropdown"
                                                    data-bs-auto-close="outside" aria-expanded="false">
                                                    <div class="avatar-group avatar-group-dense selected_users_avatar_list">
                                                        
                                                    </div>
                                                </button>
                                                <div class="dropdown-menu dropdown-menu-start py-2 scrollbar maxw-450 selected_users_final_list"
                                                    aria-labelledby="dropdownMenuButton2">
                                                    <!--End: dropdown-item -->

                                                    
                                                    <!--End: dropdown-item -->
                                                </div>
                                                <!-- End: dropdown-menu -->
                                            </div>
                                            <!-- End: dropdown -->
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12 mb-3">
                                            <div class="dropdown dropdown-with-avatars font-sans-serif position-static">
                                                <button class="btn dropdown-toggle w-100 choice_select_user"
                                                    id="dropdownMenuButton1" type="button" data-bs-toggle="dropdown"
                                                    data-bs-auto-close="outside" aria-expanded="false">
                                                    <div class="d-flex align-items-center justify-content-between">
                                                        <div class="d-flex align-items-center">
                                                            <span class="mb-0 title">Select User</span>
                                                        </div>
                                                        <span class="fas fa-chevron-down text-600 fs--1 mx-2"></span>
                                                    </div>
                                                </button>
                                                <div id="users_select"
                                                    class="dropdown-menu dropdown-menu-start py-2 scrollbar search-filter-parent"
                                                    aria-labelledby="dropdownMenuButton1">
                                                    <div class="dropdown-item">
                                                        <input id="users_search" type="search"
                                                            class="form-control form-control-sm search-filter-input"
                                                            placeholder="Search..." />
                                                    </div>
                                                    <!--End: dropdown-item -->

                                                    <!--End: dropdown-item -->
                                                </div>
                                            </div><!-- End: dropdown -->
                                        </div>
                                        <div class="col-12">
                                            <div class="row justify-content-center g-2">
                                                <div class="col-auto">
                                                    <button id="save_and_exit_button" class="btn btn-sm btn-dquam-success w-100" type="button">
                                                        Save
                                                    </button>
                                                </div>
                                                <div class="col-auto">
                                                    <button id="save_and_add_more_button" class="btn btn-sm btn-dquam-info w-100" type="button">
                                                        Save &amp; add more
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div><!--End: border, bg-white -->
                            </div>
                        </div>
                        <div class="mb-5">
                            <button id="submit_button" class="btn btn-dquam-primary btn-sm" type="button"
                                onclick="apply_changes()" disabled>Publish</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div><!-- End: modal -->
        `
    }


    function modify_page_details() {
        $("#pageTitle").text('Policy & Procedure Request');
    }

    function users_empty_check() {
        return selected_users.length === 0;
    }

    async function apply_changes() {

        try {
            if (users_empty_check()) {
                Swal.fire({
                    title: "Warning!",
                    html: "<b>" + "Please select at least 1 user" + "</b>",
                    icon: "warning"
                });
                return;
            }


            $("#loader-policy").show();

            const record_id = get_CNID_from_url();
            await update_policy(record_id);

            await handle_users_policy_acknowledgment_list(record_id);


            window.location.href = 'https://mgskw.sharepoint.com/sites/DQ/Pages/Policy_Logs.aspx';

        } catch (error) {
            console.log(error);
        }


    }

    async function handle_users_policy_acknowledgment_list(record_id) {
        await delete_existing_users_from_policy_acknowledgment_list();
        await insert_users_to_policy_acknowledgment_list(record_id);
    }



    async function delete_existing_users_from_policy_acknowledgment_list() {

        let delete_promises = existing_users.map(item => {
            delete_policy_acknowledgment_list_user(item.Id);
        });

        try {
            const results = await Promise.all(delete_promises);

            return results;
        } catch (error) {
            console.log(error);
        }

    }

    async function insert_users_to_policy_acknowledgment_list(record_id) {
        let insert_promises = selected_users.map(item => {
            add_policy_acknowledgment_list_user(record_id, item.user_id, item.title, item.email);
        });

        try {
            const results = await Promise.all(insert_promises);

            return results;
        } catch (error) {
            console.log(error);
        }
    }

    function delete_policy_acknowledgment_list_user(id) {
        return new Promise(function (resolve, reject) {
            $.ajax({
                url: _spPageContextInfo.webAbsoluteUrl + `/_api/web/lists/GetByTitle('Policy_Acknowledgment_List')/items(${id})`,
                type: "POST",
                headers:
                {
                    "X-RequestDigest": $("#__REQUESTDIGEST").val(),
                    "IF-MATCH": "*",
                    "X-HTTP-Method": "DELETE"
                },
                success: function (data) {
                    resolve();
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }

    function add_policy_acknowledgment_list_user(record_id, user_id, title, email) {
        return new Promise((resolve, reject) => {
            const obj = JSON.stringify({
                '__metadata': {
                    'type': 'SP.Data.Policy_x005f_Acknowledgment_x005f_ListListItem'
                },
                "Policy_ID": record_id,
                "Viewer_Name": title,
                "Viewer_Email": email,
                "Viewer_ID": user_id,
            });


            const headers = {
                "accept": "application/json;odata=verbose",
                "content-type": "application/json;odata=verbose",
                "X-RequestDigest": $("#__REQUESTDIGEST").val()
            };


            $.ajax({
                url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('Policy_Acknowledgment_List')/items",
                method: "POST",
                data: obj,
                headers: headers,
                success: function (data) {
                    resolve(data.d);
                },
                error: function (error) {
                    reject(error.responseText);
                }
            });
        });
    }

    function update_policy(record_id) {
        return new Promise(function (resolve, reject) {
            var seqObj = JSON.stringify({
                '__metadata': {
                    'type': 'SP.Data.Policy_x005f_ListListItem'
                },
                "Step_Number": 6,
                "Publish_Date": new Date().toISOString()

            });

            var seqHeaders = {
                "Accept": "application/json;odata=verbose",
                "Content-Type": "application/json;odata=verbose",
                "IF-MATCH": "*",
                "X-HTTP-Method": "MERGE",
                "X-RequestDigest": $("#__REQUESTDIGEST").val()
            }

            $.ajax({
                url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('Policy_List')/items(" + record_id + ")",
                method: "POST",
                async: false,
                data: seqObj,
                headers: seqHeaders,
                success: function (data) {
                    resolve();
                },
                error: function (error) {
                    reject(error)
                }
            })

        });
    }



    function apply_permissions(permission) {
        if (permission == 'read') {
            modify_main_buttons('disable');
        }

        if (permission == 'write') {
            modify_main_buttons('enable');
        }
    }


    function modify_main_buttons(status) {
        if (status == 'disable') {
            $('#submit_button').prop('disabled', true);
            $('#publishing_list_button').prop('disabled', true);
            $('#open_ms_team_button').prop('disabled', true);
        }

        if (status == 'enable') {
            $('#submit_button').prop('disabled', false);
            $('#publishing_list_button').prop('disabled', false);
            $('#open_ms_team_button').prop('disabled', false);

        }
    }



    async function populate_fields(policy, record_id) {
        $("#policy_title").html(policy.Request_title);
        $("#policy_description").html(policy.Policy_Description);

        let status_class = get_status_css_class(policy);

        $("#policy_status, #policy_status_top").html(policy.Status);
        $("#policy_status, #policy_status_top").addClass(status_class);

        $("#policy_revision_number").html(policy.Revision_Number !== null ? policy.Revision_Number : '');
        $("#policy_revision_date").html(new Date(policy.Next_Revision_Date).format('dd/MM/yyyy'));
        $("#policy_publishing_date").html(new Date(policy.Publish_Date).format('dd/MM/yyyy'));

        $('#view_file').attr('data-file-url', policy.Policy_Template_URL);

        await populate_documents(record_id);

        await populate_users_from_DB(record_id);
    }

    async function populate_users_from_DB(record_id) {
        existing_users = await get_users_from_policy_acknowledgment_list(record_id);

        selected_users = existing_users.map(user => {
            return {
                user_id: user.Viewer_ID,
                title: user.Viewer_Name,
                email: user.Viewer_Email,
                image: _spPageContextInfo.webAbsoluteUrl + '/_layouts/15/userphoto.aspx?size=S&accountname=' + user.Viewer_Email
            };
        });

        populate_selected_users();

    }

    function get_users_from_policy_acknowledgment_list(record_id) {
        return new Promise(function (resolve, reject) {
            let select = "$select=Id,Viewer_Name,Viewer_Email,Viewer_ID";
            let filter = `$filter=Policy_ID eq ${record_id}`;
            $.ajax({
                url: _spPageContextInfo.webAbsoluteUrl + `/_api/web/lists/GetByTitle('Policy_Acknowledgment_List')/items?${select}&${filter}`,
                method: "GET",
                headers: {
                    "ACCEPT": "application/json; odata=verbose",
                },
                success: function (data) {
                    resolve(data.d.results);
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }


    async function populate_documents(record_id) {
        let documents = await get_policy_documents(record_id);
        let html = ``;
        documents.forEach(doc => {
            html += `
            <div class="border p-2 rounded-3 d-flex bg-white dark__bg-1000 fs--1 m-2">
                <span class="fs-1 far fa-image"></span>
                <span class="ms-2 me-3">${doc.LinkFilename}</span>
                <div class="text-300 ms-auto clickable-doc-pointer" onclick="open_viewable_doc('Policy Attachments', '${doc.LinkFilename}', '${doc.GUID}')" data-bs-toggle="tooltip" data-bs-placement="right"
                    aria-label="View" data-bs-original-title="View">
                    <span class="fas fa-arrow-down"></span>
                </div>
            </div>
            `
        });

        $("#policy_docs").html(html);
    }

</script>