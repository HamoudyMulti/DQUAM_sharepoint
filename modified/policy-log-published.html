<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css">

<script src="/sites/DQ/_catalogs/masterpage/DQUAM/DQUAM Configs/DQUAM Configs/JS/policy-common-functions.js"></script>

<div class="content">

    <div class="container px-0">


        <div class="row">
            <div class="col">
                <h5 class="fs-0 pt-2 pb-3 d-lg-none">Published Policy Log</h5>
            </div>
        </div>


        <!-- ################################### Inner Contents ################################ -->

        <div class="content-inner p-lg-4">
            <!-- BreadCrumb-->
            <div class="row mb-3 mb-xl-4">
                <div class="col">
                    <nav style="--falcon-breadcrumb-divider: 'Â»';" aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a
                                    href="https://mgskw.sharepoint.com/sites/DQ/Pages/gaps-dash.aspx">Quality
                                    Documentation</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Published Policy Log</li>
                        </ol>
                    </nav>
                </div>
            </div>

            <!-- ============ page contents here... =========== -->
            <div class="card z-1 mb-3" id="tablePolicyLog"
                data-list='{"valueNames":["id","stage","status","dueDate","department","documentLink"],"page":5,"pagination":true}'>
                <div class="card-header">
                    <div class="row flex-between-center">
                        <div class="col-12 col-xl order-2 order-xl-1 collapse-lower-than-120077 collapse d-xl-flex"
                            id="PolicyLogFilters">
                            <div class="row g-3 align-items-center">
                                <div class="col-12 col-xl-auto">
                                    <span class="fas fa-filter" data-fa-transform="shrink-3"></span>
                                    filters:
                                </div>
                                <div class="col-12 col-xl-auto">
                                    <select id="search_status" class="form-select form-select-sm">
                                        <option value="" selected="">Status</option>
                                        <option value="active">active</option>
                                        <option value="obsolete">obsolete</option>
                                    </select>
                                </div>

                                <div class="col-12 col-xl-auto">
                                    <select id="search_department" class="form-select form-select-sm">
                                        <option value="" selected="">Department</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                    </select>
                                </div>

                                <div class="col-12 col-xl-auto">
                                    <div class="search-box w-100" data-list='{"valueNames":["title"]}'>
                                        <input id="search_title" class="form-control form-control-sm search-input fuzzy-search rounded-3"
                                            type="search" placeholder="Search title..." aria-label="Search" />
                                        <span class="fas fa-search search-box-icon"></span>
                                       
                                    </div>
                                </div>




                            </div>
                        </div>
                        <div class="col-12 col-xl-auto order-1 order-xl-2 mb-1 mb-xl-0">
                            <div class="row g-2 align-items-center justify-content-end">
                                <div class="col-auto">
                                    <button class="btn btn-falcon-default btn-sm d-xl-none" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#PolicyLogFilters"
                                        aria-expanded="false" aria-controls="PolicyLogFilters">
                                        <span class="fas fa-filter" data-fa-transform="shrink-3 down-2"></span>
                                    </button>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-dquam-success btn-sm" type="button"
                                        onclick="location.href='https://mgskw.sharepoint.com/sites/DQ/Pages/policy-request-initiator.aspx'">
                                        <span class="fas fa-plus" data-fa-transform="shrink-3 down-2"></span>
                                        <span class="d-none d-sm-inline-block ms-1">New</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- End: card-header -->
                <div class="card-body px-0 py-0">
                    <div class="table-responsive scrollbar">
                        <table class="table table-bordered table-striped fs--1 mb-0">
                            <thead class="bg-200 text-900">
                                <tr>
                                    <th class="sort" data-sort="id">Policy No.</th>
                                    <th>Title</th>
                                    <th class="sort text-center">Revision No.</th>
                                    <th class="sort text-center">Status</th>
                                    <th class="sort text-center">Next Revision Date</th>
                                    <th class="sort text-center">Publishing Date</th>
                                    <th class="sort text-center">Document Link</th>
                                </tr>
                            </thead>
                            <tbody class="list" id="tbl-policy-logs">

                            </tbody>
                        </table>
                    </div><!-- End: table-responsive -->
                </div><!-- End: card-body -->
                <div class="card-footer">
                    <div class="row align-items-center mt-3">
                        <div class="pagination d-none"></div>
                        <div class="col">
                            <p class="mb-0 fs--1">
                                <span class="d-none d-sm-inline-block" data-list-info="data-list-info"></span>
                                <span class="d-none d-sm-inline-block"> &mdash;</span>
                                <a class="fw-semi-bold text-info" href="#!" data-list-view="*">
                                    View all <span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span>
                                </a>
                                <a class="fw-semi-bold d-none" href="#!" data-list-view="less">
                                    View Less <span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span>
                                </a>
                            </p>
                        </div>
                        <div class="col-auto d-flex">
                            <button id="previous_button" class="btn btn-sm btn-dquam-info" type="button"
                                data-list-pagination="prev">
                                <span>Previous</span>
                            </button>
                            <button id="next_button" class="btn btn-sm btn-dquam-info px-4 ms-2" type="button"
                                data-list-pagination="next">
                                <span>Next</span>
                            </button>
                        </div>
                    </div>
                </div><!-- End: card-footer -->
            </div><!-- End: #tablePolicyLog -->

        </div><!-- End: content-inner -->

    </div><!-- End: content -->

</div><!-- End: container -->


<script type="text/javascript">

    let pagination_list = [""];
    let page = 1;

    let limit = 8;
    let order_by = "ID desc";

    let filter = "";

    $(document).ready(function () {
        on_change_status();
        on_change_department();
        on_change_title();


        on_click_next();
        on_click_previous();


        modify_page_details();
        retrieve_table_data("", "");
    });


    function modify_page_details() {
        $("#pageTitle").text('Published Policy Log');
    }

    async function retrieve_table_data(pagination, filter) {
        if (pagination === "") {
            page = 1;
            pagination_list = [""];
        }

        let data = await retrive_list_items(pagination, filter);
        if (data.__next) {
            const regex = /p_ID%3d(\d+)/;
            const match = data.__next.match(regex);
            if (page === pagination_list.length) {
                pagination_list.push(`%26p_ID=${match[1]}`);
            }
        }

        populate_table('#tbl-policy-logs', data.results);

    }

    async function retrive_list_items(pagination, filter) {

        let current_user = get_current_user_id();

        if (filter) {
            filter += ' and ';
        }
        filter += `(Step_Number eq 6 or Step_Number eq 7)`;
        

        if (await quality_team_check(current_user)) {
            // Quality team check passed, no user filter
        } else {
            if (filter) {
                filter += ' and ';
            }
            filter += `
            (
                (
                    Preparation_Approvers/Approver_Name_User_ID eq ${current_user} and 
                    (Step_Number eq 6 or Step_Number eq 7)
                )

                or 
                (
                    Stakeholders_Approvers/Approver_Name_User_ID eq ${current_user} and 
                    (Step_Number eq 6 or Step_Number eq 7)
                )
                or
                (
                    Regulators_Approvers/Approver_Name_User_ID eq ${current_user} and 
                    (Step_Number eq 6 or Step_Number eq 7)
                )
                or
                (
                    AuthorId eq ${current_user}
                )
            )
             `;
        }


        return new Promise(function (resolve, reject) {
            $.ajax({
                url: _spPageContextInfo.webAbsoluteUrl + `/_api/web/lists/GetByTitle('Policy_List')/Items?$OrderBy=${order_by}&$top=${limit}&$skiptoken=Paged=TRUE${pagination}&$filter=${filter}`,
                method: "GET",
                headers: {
                    "ACCEPT": "application/json; odata=verbose",
                },
                success: function (data) {
                    resolve(data.d);
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }




    function populate_table(table_id, data) {
        html = '';
        if (data.length > 0) {
            $(data).each(function (index, value) {
                html += populate_table_row(value);
            });
        }
        $(table_id).html(html);
    }


    function populate_table_row(value) {

        let status_class = get_status_css_class(value);

        let view_file_html;

        switch (value.Step_Number) {
            case 6:
            case 7:
                view_file_html = `
                    <td class="documentLink text-center">
                        <button type="button" onclick="open_doc_new_tab('${value.Policy_Published_URL}')" class="btn btn-dquam-secondary btn-sm">
                            <span class="fas fa-file"></span>
                            View File
                        </button>
                    </td>
                `
                break;
            default:
                view_file_html = `<td></td>`;
                break;
        }



        return `
            <tr>
                <td class="id">${value.Sequence_Number}</td>
                <td>
                    <span class="d-inline-block text-truncate maxw-250" data-bs-toggle="tooltip" data-bs-placement="top" title="">
                        ${value.Request_title}
                    </span>
                </td>
                <td class="stage text-center">
                    <span>${value.Revision_Number !== null ? value.Revision_Number : ''}</span>
                </td>
                <td class="status text-center">
                    <span class="badge rounded ${status_class} p-2 minw-80">${value.Status !== null ? value.Status : ''}</span>
                </td>
                <td class="dueDate text-center">${new Date(value.Next_Revision_Date).format('dd/MM/yyyy')}</td>
                <td class="dueDate text-center">${new Date(value.Publish_Date).format('dd/MM/yyyy')}</td>
                ${view_file_html}
            </tr>`
    }

    




    function on_change_status() {
        $('#search_status').on('change', function () {
            filter_table();
        });
    }



    function on_change_department() {
        $('#search_department').on('change', function () {
            filter_table();
        });
    }

    function on_change_title(){
        $('#search_title').on('input', function () {
            filter_table();
        });
    }

    function filter_table() {
        filter = "";
        let search_status = $('#search_status').val();
        let search_department = $('#search_department').val();
        let search_title = $('#search_title').val();



        if (search_department) {
            filter += `Department eq '${search_department}'`;
        }


        if (search_status) {
            if (filter) {
                filter += ' and ';
            }
            filter += `Status eq '${search_status}'`;
        }

        if (search_title) {
            if (filter) {
                filter += ' and ';
            }
            filter += `substringof('${search_title}', Request_title)`;
        }

        retrieve_table_data(``, filter);

    }


    function on_click_next() {
        $("#next_button").click(function () {
            if (page < pagination_list.length) {
                page++;
                retrieve_table_data(`${pagination_list[page - 1]}`, filter);
            }
        });
    }


    function on_click_previous() {
        $("#previous_button").click(function () {
            if (page > 1) {
                page--;
                retrieve_table_data(`${pagination_list[page - 1]}`, filter);
            }

        });
    }






</script>