<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css">

<script src="/sites/DQ/_catalogs/masterpage/DQUAM/DQUAM Configs/DQUAM Configs/JS/policy-common-functions.js"></script>
<link rel="stylesheet" href="/sites/DQ/_catalogs/masterpage/DQUAM/DQUAM Configs/DQUAM Configs/CSS/policy-common-stylesheet.css">

<div class="content">
    <div id="loader-policy" class="loader-policy"></div>


    <div class="row">
        <div class="col">
            <h5 class="fs-0 pt-2 pb-3 d-lg-none">Policy &amp; Procedure Request</h5>
        </div>
    </div>


    <!-- ################################### Inner Contents ################################ -->

    <div class="content-inner p-lg-4">
        <!-- BreadCrumb-->
        <div class="row mb-3 mb-xl-4">
            <div class="col">
                <nav style="--falcon-breadcrumb-divider: 'Â»';" aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a
                                href="https://mgskw.sharepoint.com/sites/DQ/Pages/gaps-dash.aspx">Quality
                                Documentation</a></li>
                        <li class="breadcrumb-item active"><a href="#">Policy &amp; Procedure Request</a></li>
                    </ol>
                </nav>
            </div>
        </div>

        <!-- Details/History tabs -->
        <div class="row align-items-center justify-content-between mb-3 mb-xl-4">
            <div class="col-12 col-xl-auto mb-2 mb-xl-0">
                <div class="btn-group btn-group-sm" role="group">
                    <a href="https://mgskw.sharepoint.com/sites/DQ/Pages/policy-request-readonly.aspx"
                        class="btn btn-dquam-primary" role="button">Details</a>
                    <a href="https://mgskw.sharepoint.com/sites/DQ/Pages/policy-request-history.aspx"
                        class="btn btn-outline-secondary" role="button">History</a>
                </div>
            </div>
            <div class="col-12 col-xl-auto">
                <div class="row g-2">
                    <div class="col-auto">
                        <button id="make_obsolete_button" class="btn btn-dquam-info btn-sm" type="button"
                            onclick="apply_changes()" disabled>Make Obsolete</button>
                    </div>
                    <div class="col-auto">
                        <button id="change_request_button" class="btn btn-dquam-primary btn-sm" type="button"
                            onclick="apply_change_request()" disabled>Change Request</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ page contents here... =========== -->

        <div class="card p-0 mb-4">
            <div class="card-body p-xl-3">

                <div class="row">
                    <div class="col">
                        <div class="theme-wizard theme-wizard-common-style">
                            <ul class="nav justify-content-between nav-wizard">
                                <li class="nav-item">
                                    <a class="nav-link fw-semi-bold done">
                                        <span class="nav-item-circle-parent">
                                            <span class="nav-item-circle">
                                                <span class="fas fa-hourglass-end"></span>
                                            </span>
                                        </span>
                                        <span class="d-none d-md-block mt-1 fs--1">Request Approval</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link fw-semi-bold done">
                                        <span class="nav-item-circle-parent">
                                            <span class="nav-item-circle">
                                                <span class="fas fa-magic"></span>
                                            </span>
                                        </span>
                                        <span class="d-none d-md-block mt-1 fs--1">Under Preparation</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link fw-semi-bold done">
                                        <span class="nav-item-circle-parent">
                                            <span class="nav-item-circle">
                                                <span class="fas fa-hourglass-end"></span>
                                            </span>
                                        </span>
                                        <span class="d-none d-md-block mt-1 fs--1">Stakeholders Approval</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link fw-semi-bold done">
                                        <span class="nav-item-circle-parent">
                                            <span class="nav-item-circle">
                                                <span class="fas fa-hourglass-end"></span>
                                            </span>
                                        </span>
                                        <span class="d-none d-md-block mt-1 fs--1">Regulators Approval</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link fw-semi-bold done">
                                        <span class="nav-item-circle-parent">
                                            <span class="nav-item-circle">
                                                <span class="fas fa-location-arrow"></span>
                                            </span>
                                        </span>
                                        <span class="d-none d-md-block mt-1 fs--1">Publish</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link fw-semi-bold active">
                                        <span class="nav-item-circle-parent">
                                            <span class="nav-item-circle">
                                                <span class="fas fa-check"></span>
                                            </span>
                                        </span>
                                        <span class="d-none d-md-block mt-1 fs--1">Completed</span>
                                    </a>
                                </li>
                            </ul>
                        </div><!--End: theme-wizard -->
                    </div>
                </div>

            </div><!--End: card-body -->
        </div><!--End: card -->

        <div class="card">
            <div class="card-body p-xl-5">
                <div class="row justify-content-end mb-3">
                    <div class="col-auto">
                        <button id="view_file" onclick="open_doc_new_tab($(this).data('file-url'))" class="btn btn-dquam-info" type="button">
                            <span class="fas fa-file"></span>
                            <span class="ms-1">View File</span>
                        </button>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label text-900 fs-0 mb-1">Policy &amp; Procedure Title</label>
                    </div>
                    <div class="col-12">
                        <span id="policy_title" class="fs--1 text-600"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label text-900 fs-0 mb-1">Policy &amp; Procedure Description</label>
                    </div>
                    <div class="col-12">
                        <span id="policy_description" class="fs--1 text-600"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label text-900 fs-0 mb-1">Supporting Documents</label>
                    </div>
                    <div class="col-12">
                        <div id="policy_docs" class="d-flex flex-column777 flex-wrap">

                        </div>
                    </div>
                </div>
                <div class="row justify-content-between">
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label text-900 fs-0 mb-1">Status</label>
                            </div>
                            <div class="col-12">
                                <span id="policy_status" class="badge rounded p-2 minw-80"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label text-900 fs-0 mb-1">Revision Number</label>
                            </div>
                            <div class="col-12">
                                <span id="policy_revision_number" class="fs--1 text-600"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label text-900 fs-0 mb-1">Next Revision Date</label>
                            </div>
                            <div class="col-12">
                                <span id="policy_revision_date" class="fs--1 text-600"></span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label text-900 fs-0 mb-1">Publishing Date</label>
                            </div>
                            <div class="col-12">
                                <span id="policy_publishing_date" class="fs--1 text-600"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!--End: card -->

    </div><!-- End: content-inner -->

</div><!-- End: content -->


<script>

    $(document).ready(async function () {
        try {
            const record_id = get_CNID_from_url();

            let current_user = get_current_user_id();

            console.log("current_user", current_user)

            let selected_policy = await get_policy_info(record_id, "$select=*,Author/Id", "$expand=Author");

            let approvers_list = await get_approvers_list(record_id, null);

            let step_number = selected_policy.Step_Number;

            step_number_check(step_number, [6, 7]);



            let access = await check_user_access(record_id, selected_policy, current_user, approvers_list);
            if (access == 'unauthorized') {
                redirect_user_to_home_page();
                return;
            }
            console.log("access", access);



            let permission = check_user_permissions(access, step_number);
            if (permission == 'none') {
                redirect_user_to_home_page();
                return;
            }
            console.log("permission", permission);



            modify_page_details();
            await populate_fields(selected_policy, record_id);
            apply_permissions(permission);



        } catch (error) {
            console.error(error);
        }
    });

    function modify_page_details() {
        $("#pageTitle").text('Policy & Procedure Request');
    }


    async function apply_changes() {
        $("#loader-policy").show();

        try {
            const record_id = get_CNID_from_url();
            await update_policy(record_id, 7, "obsolete");

            window.location.href = 'https://mgskw.sharepoint.com/sites/DQ/Pages/Policy_Logs.aspx';

        } catch (error) {
            console.log(error);
        }


    }

    async function apply_change_request() {
        $("#loader-policy").show();
        
        try {
            const record_id = get_CNID_from_url();
            await update_policy(record_id, 1, null);

            window.location.href = 'https://mgskw.sharepoint.com/sites/DQ/Pages/Policy_Logs.aspx';

        } catch (error) {
            console.log(error);
        }


    }

    function update_policy(record_id, step_number, status) {
        return new Promise(function (resolve, reject) {
            var seqObj = JSON.stringify({
                '__metadata': {
                    'type': 'SP.Data.Policy_x005f_ListListItem'
                },
                "Step_Number": step_number,
                ...(status && { "Status": status })

            });

            var seqHeaders = {
                "Accept": "application/json;odata=verbose",
                "Content-Type": "application/json;odata=verbose",
                "IF-MATCH": "*",
                "X-HTTP-Method": "MERGE",
                "X-RequestDigest": $("#__REQUESTDIGEST").val()
            }

            $.ajax({
                url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('Policy_List')/items(" + record_id + ")",
                method: "POST",
                async: false,
                data: seqObj,
                headers: seqHeaders,
                success: function (data) {
                    resolve();
                },
                error: function (error) {
                    reject(error)
                }
            })

        });
    }



    function apply_permissions(permission) {
        if (permission == 'read') {
            modify_main_buttons('disable');
        }

        if (permission == 'write') {
            modify_main_buttons('enable');
        }
    }


    function modify_main_buttons(status) {
        if (status == 'disable') {
            $('#make_obsolete_button').prop('disabled', true);
            $('#change_request_button').prop('disabled', true);
        }

        if (status == 'enable') {
            $('#make_obsolete_button').prop('disabled', false);
            $('#change_request_button').prop('disabled', false);

        }
    }



    async function populate_fields(policy, record_id) {

        
        $("#policy_title").html(policy.Request_title);
        $("#policy_description").html(policy.Policy_Description);
        
        
        let status_class = get_status_css_class(policy);

        $("#policy_status").html(policy.Status);
        $("#policy_status").addClass(status_class);

        $("#policy_revision_number").html(policy.Revision_Number !== null ? policy.Revision_Number : '');
        $("#policy_revision_date").html(new Date(policy.Next_Revision_Date).format('dd/MM/yyyy'));
        $("#policy_publishing_date").html(new Date(policy.Publish_Date).format('dd/MM/yyyy'));

        $('#view_file').attr('data-file-url', policy.Policy_Template_URL);



        await populate_documents(record_id);
    }


    async function populate_documents(record_id) {
        let documents = await get_policy_documents(record_id);
        let html = ``;
        documents.forEach(doc => {
            html += `
            <div class="border p-2 rounded-3 d-flex bg-white dark__bg-1000 fs--1 m-2">
                <span class="fs-1 far fa-image"></span>
                <span class="ms-2 me-3">${doc.LinkFilename}</span>
                <a class="text-300 ms-auto" href="${doc.EncodedAbsUrl}" target="_blank" data-bs-toggle="tooltip" data-bs-placement="right"
                    aria-label="Download" data-bs-original-title="Download">
                    <span class="fas fa-arrow-down"></span>
                </a>
            </div>
            `
        });

        $("#policy_docs").html(html);
    }

</script>