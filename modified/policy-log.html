<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css">

<script src="/sites/DQ/_catalogs/masterpage/DQUAM/DQUAM Configs/DQUAM Configs/JS/policy-common-functions.js"></script>
<link rel="stylesheet" href="/sites/DQ/_catalogs/masterpage/DQUAM/DQUAM Configs/DQUAM Configs/CSS/breadcrumb-navigation-fix.css">

<div class="content">

    <div class="container px-0">


        <div class="row">
            <div class="col">
                <h5 class="fs-0 pt-2 pb-3 d-lg-none">Policy Log</h5>
            </div>
        </div>


        <!-- ################################### Inner Contents ################################ -->

        <div class="content-inner p-lg-4">
            <!-- BreadCrumb-->
            <div class="row mb-3 mb-xl-4">
                <div class="col">
                    <nav class="breadcrumb-navigation-fix" aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a
                                    href="https://mgskw.sharepoint.com/sites/DQ/Pages/gaps-dash.aspx">Quality
                                    Documentation</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Policy Log</li>
                        </ol>
                    </nav>
                </div>
            </div>

            <!-- ============ page contents here... =========== -->
            <div class="card z-1 mb-3" id="tablePolicyLog"
                data-list='{"valueNames":["id","stage","status","dueDate","department","documentLink"],"page":5,"pagination":true}'>
                <div class="card-header">
                    <div class="row flex-between-center">
                        <div class="col-12 col-xl order-2 order-xl-1 collapse-lower-than-120077 collapse d-xl-flex"
                            id="PolicyLogFilters">
                            <div class="row g-3 align-items-center">
                                <div class="col-12 col-xl-auto">
                                    <span class="fas fa-filter" data-fa-transform="shrink-3"></span>
                                    filters:
                                </div>
                                <div class="col-12 col-xl-auto">
                                    <select id="search_status" class="form-select form-select-sm">
                                        <option value="" selected="">Status</option>
                                        <option value="New">New</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Active">Active</option>
                                        <option value="Delayed">Delayed</option>
                                        <option value="Obsolete">Obsolete</option>
                                    </select>
                                </div>
                                <div class="col-12 col-xl-auto">
                                    <select id="search_stage" class="form-select form-select-sm">
                                        <option value="" selected="">Stage</option>
                                        <option value="1">Quality Team</option>
                                        <option value="2">Preparation Team</option>
                                        <option value="3">Stakeholders</option>
                                        <option value="4">Regulators</option>
                                        <option value="5">Publish</option>
                                        <option value="6">Completed</option>
                                        <option value="7">Obsolete</option>
                                        <option value="11">Send Back By Quality</option>
                                        <option value="33">Send Back By Stakeholders</option>
                                        <option value="44">Send Back By Regulators</option>
                                    </select>
                                </div>
                                <div class="col-12 col-xl-auto">
                                    <select id="search_department" class="form-select form-select-sm">
                                        <option value="" selected="">Department</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-xl-auto order-1 order-xl-2 mb-1 mb-xl-0">
                            <div class="row g-2 align-items-center justify-content-end">
                                <div class="col-auto">
                                    <button class="btn btn-falcon-default btn-sm d-xl-none" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#PolicyLogFilters"
                                        aria-expanded="false" aria-controls="PolicyLogFilters">
                                        <span class="fas fa-filter" data-fa-transform="shrink-3 down-2"></span>
                                    </button>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-dquam-success btn-sm" type="button"
                                        onclick="location.href='https://mgskw.sharepoint.com/sites/DQ/Pages/policy-request-initiator.aspx'">
                                        <span class="fas fa-plus" data-fa-transform="shrink-3 down-2"></span>
                                        <span class="d-none d-sm-inline-block ms-1">New</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- End: card-header -->
                <div class="card-body px-0 py-0">
                    <div class="table-responsive scrollbar">
                        <table class="table table-bordered table-striped fs--1 mb-0">
                            <thead class="bg-200 text-900">
                                <tr>
                                    <th class="sort" data-sort="id">Policy No.</th>
                                    <th>Title</th>
                                    <th class="sort text-center" data-sort="stage">Stage</th>
                                    <th class="sort text-center" data-sort="status">Status</th>
                                    <th class="sort text-center" data-sort="dueDate">Due Date</th>
                                    <th class="sort text-center" data-sort="department">Department</th>
                                    <th class="sort text-center" data-sort="documentLink">Document Link</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody class="list" id="tbl-policy-logs">

                            </tbody>
                        </table>
                    </div><!-- End: table-responsive -->
                </div><!-- End: card-body -->
                <div class="card-footer">
                    <div class="row align-items-center mt-3">
                        <div class="pagination d-none"></div>
                        <div class="col">
                            <p class="mb-0 fs--1">
                                <span class="d-none d-sm-inline-block" data-list-info="data-list-info"></span>
                                <span class="d-none d-sm-inline-block"> &mdash;</span>
                                <a class="fw-semi-bold text-info" href="#!" data-list-view="*">
                                    View all <span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span>
                                </a>
                                <a class="fw-semi-bold d-none" href="#!" data-list-view="less">
                                    View Less <span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span>
                                </a>
                            </p>
                        </div>
                        <div class="col-auto d-flex">
                            <button id="previous_button" class="btn btn-sm btn-dquam-info" type="button"
                                data-list-pagination="prev">
                                <span>Previous</span>
                            </button>
                            <button id="next_button" class="btn btn-sm btn-dquam-info px-4 ms-2" type="button"
                                data-list-pagination="next">
                                <span>Next</span>
                            </button>
                        </div>
                    </div>
                </div><!-- End: card-footer -->
            </div><!-- End: #tablePolicyLog -->

        </div><!-- End: content-inner -->

    </div><!-- End: content -->

</div><!-- End: container -->


<script type="text/javascript">

    let pagination_list = [""];
    let page = 1;

    let limit = 8;
    let order_by = "ID desc";

    let filter = "";

    $(document).ready(async function () {
        await populate_departments_dropdown();
        
        on_change_status();
        on_change_stage();
        on_change_department();

        on_click_next();
        on_click_previous();


        modify_page_details();
        retrieve_table_data("", "");
    });


    function modify_page_details() {
        $("#pageTitle").text('Policy Log');
    }

    async function retrieve_table_data(pagination, filter) {
        if (pagination === "") {
            page = 1;
            pagination_list = [""];
        }

        let data = await retrive_list_items(pagination, filter);
        if (data.__next) {
            const regex = /p_ID%3d(\d+)/;
            const match = data.__next.match(regex);
            if (page === pagination_list.length) {
                pagination_list.push(`%26p_ID=${match[1]}`);
            }
        }

        populate_table('#tbl-policy-logs', data.results);

    }

    async function retrive_list_items(pagination, filter) {

        let current_user = get_current_user_id();

        if (await quality_team_check(current_user)) {
            // Quality team check passed, no user filter
        } else {
            if (filter) {
                filter += ' and ';
            }
            filter += `
            (
                (
                    Preparation_Approvers/Approver_Name_User_ID eq ${current_user} and 
                    (Step_Number eq 2 or Step_Number eq 3 or Step_Number eq 4 or Step_Number eq 5 or Step_Number eq 6 or Step_Number eq 33 or Step_Number eq 44)
                )

                or 
                (
                    Stakeholders_Approvers/Approver_Name_User_ID eq ${current_user} and 
                    (Step_Number eq 3 or Step_Number eq 4 or Step_Number eq 5 or Step_Number eq 6 or Step_Number eq 33 or Step_Number eq 44)
                )
                or
                (
                    Regulators_Approvers/Approver_Name_User_ID eq ${current_user} and 
                    (Step_Number eq 4 or Step_Number eq 5 or Step_Number eq 6 or Step_Number eq 44)
                )
                or
                (
                    AuthorId eq ${current_user}
                )
            )
             `;
        }


        return new Promise(function (resolve, reject) {
            $.ajax({
                url: _spPageContextInfo.webAbsoluteUrl + `/_api/web/lists/GetByTitle('Policy_List')/Items?$OrderBy=${order_by}&$top=${limit}&$skiptoken=Paged=TRUE${pagination}&$filter=${filter}`,
                method: "GET",
                headers: {
                    "ACCEPT": "application/json; odata=verbose",
                },
                success: function (data) {
                    resolve(data.d);
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }




    function populate_table(table_id, data) {
        html = '';
        if (data.length > 0) {
            $(data).each(function (index, value) {
                html += populate_table_row(value);
            });
        }
        $(table_id).html(html);
    }


    function populate_table_row(value) {

        let status_class = get_status_css_class(value);

        
        let view_file_html;

        let step_stage_detail = get_step_stage_detail(value.Step_Number);

        switch (value.Step_Number) {
            case 2:
            case 3:
            case 4:
            case 5:
            case 6:
            case 7:
            case 33:
            case 44:
                view_file_html = `
                    <td class="documentLink text-center">
                        <button type="button" onclick="open_doc_new_tab('${encodeURIComponent(value.Policy_Template_URL)}')" class="btn btn-dquam-secondary btn-sm">
                            <span class="fas fa-file"></span>
                            View File
                        </button>
                    </td>
                `
                break;
            default:
                view_file_html = `<td></td>`;
                break;
        }



        return `
            <tr>
                <td class="id">${value.Sequence_Number}</td>
                <td>
                    <span class="d-inline-block text-truncate maxw-250" data-bs-toggle="tooltip" data-bs-placement="top" title="">
                        ${value.Request_title}
                    </span>
                </td>
                <td class="stage text-center">
                    <span>${step_stage_detail}</span>
                </td>
                <td class="status text-center">
                    <span class="badge rounded ${status_class} p-2 minw-80">${value.Status !== null ? value.Status : ''}</span>
                </td>
                <td class="dueDate text-center">${value.Due_Date ? new Date(value.Due_Date).format('dd/MM/yyyy') : ''}</td>
                <td class="department text-center">${value.Department}</td>
                ${view_file_html}
                <td class="text-center">
                    <div class="btn-group font-sans-serif position-static">
                        <button class="btn btn-link btn-sm text-600 dropdown-toggle" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false">
                            <span class="fas fa-ellipsis-h fs--1"></span>
                        </button>
                        <div class="dropdown-menu">
                            <button type="button" class="dropdown-item" onclick="view_details(${value.ID})">View Details</button>
                            <button type="button" class="dropdown-item" onclick="view_history(${value.ID})">View History</button>
                            <button type="button" class="dropdown-item" onclick="window.location.href='https://mgskw.sharepoint.com/sites/DQ/Pages/request-meeting.aspx?CNID=${value.ID}'">Meeting Request</button>
                            <a class="dropdown-item" href="#">Open MS Teams</a>
                            <a class="dropdown-item" href="#">Dynamic Action</a>
                            <button class="dropdown-item text-danter" onclick="delete_record(${value.ID})">Delete</a>
                        </div>
                    </div>
                </td>
            </tr>`
    }




    function delete_record(record_id) {
        event.preventDefault();

        $.ajax({
            url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('Policy_List')/items(" + record_id + ")",
            type: "POST",
            async: false,
            headers: {
                "Accept": "application/json;odata=verbose",
                "X-Http-Method": "DELETE",
                "X-RequestDigest": $("#__REQUESTDIGEST").val(),
                "If-Match": "*"
            },
            success: function (data) {
                retrieve_table_data("", filter);
            },
            error: function (error) {
                console.log(JSON.stringify(error))
            }
        });
    }


    function on_change_status() {
        $('#search_status').on('change', function () {
            filter_table();
        });
    }


    function on_change_stage() {
        $('#search_stage').on('change', function () {
            filter_table();
        });
    }


    function on_change_department() {
        $('#search_department').on('change', function () {
            filter_table();
        });
    }

    function filter_table() {
        filter = "";
        let search_status = $('#search_status').val();
        let search_stage = $('#search_stage').val();
        let search_department = $('#search_department').val();



        if (search_department) {
            filter += `Department eq '${search_department}'`;
        }

        if (search_stage) {
            if (filter) {
                filter += ' and ';
            }
            filter += `Step_Number eq '${search_stage}'`;
        }

        if (search_status) {
            if (filter) {
                filter += ' and ';
            }
            filter += `Status eq '${search_status}'`;
        }

        retrieve_table_data(``, filter);

    }


    function on_click_next() {
        $("#next_button").click(function () {
            if (page < pagination_list.length) {
                page++;
                retrieve_table_data(`${pagination_list[page - 1]}`, filter);
            }
        });
    }


    function on_click_previous() {
        $("#previous_button").click(function () {
            if (page > 1) {
                page--;
                retrieve_table_data(`${pagination_list[page - 1]}`, filter);
            }

        });
    }



    function get_policy_info(record_id) {
        return new Promise(function (resolve, reject) {
            $.ajax({
                url: _spPageContextInfo.webAbsoluteUrl + `/_api/web/lists/GetByTitle('Policy_List')/items(${record_id})`,
                method: "GET",
                headers: {
                    "ACCEPT": "application/json; odata=verbose",
                },
                success: function (data) {
                    resolve(data.d);
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }




</script>