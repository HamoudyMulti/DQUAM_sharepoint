<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css">

<div class="content">

    <div class="container px-0">


        <div class="row">
            <div class="col">
                <h5 class="fs-0 pt-2 pb-3 d-lg-none">Policy Log</h5>
            </div>
        </div>


        <!-- ################################### Inner Contents ################################ -->

        <div class="content-inner p-lg-4">
            <!-- BreadCrumb-->
            <div class="row mb-3 mb-xl-4">
                <div class="col">
                    <nav style="--falcon-breadcrumb-divider: 'Â»';" aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a
                                    href="https://mgskw.sharepoint.com/sites/DQ/Pages/gaps-dash.aspx">Quality
                                    Improvement</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Policy Log</li>
                        </ol>
                    </nav>
                </div>
            </div>

            <!-- ============ page contents here... =========== -->
            <div class="card z-1 mb-3" id="tablePolicyLog"
                data-list='{"valueNames":["id","stage","status","dueDate","department","documentLink"],"page":5,"pagination":true}'>
                <div class="card-header">
                    <div class="row flex-between-center">
                        <div class="col-12 col-xl order-2 order-xl-1 collapse-lower-than-120077 collapse d-xl-flex"
                            id="PolicyLogFilters">
                            <div class="row g-3 align-items-center">
                                <div class="col-12 col-xl-auto">
                                    <span class="fas fa-filter" data-fa-transform="shrink-3"></span>
                                    filters:
                                </div>
                                <div class="col-12 col-xl-auto">
                                    <select id="search_status" class="form-select form-select-sm">
                                        <option value="" selected="">Status</option>
                                        <option value="in progress">in progress</option>
                                        <option value="closed">closed</option>
                                        <option value="sticky">sticky</option>
                                    </select>
                                </div>
                                <div class="col-12 col-xl-auto">
                                    <select id="search_stage" class="form-select form-select-sm">
                                        <option value="" selected="">Stage</option>
                                        <option value="Quality">Quality</option>
                                        <option value="Preparation Team">Preparation Team</option>
                                        <option value="Completed">Completed</option>
                                    </select>
                                </div>
                                <div class="col-12 col-xl-auto">
                                    <select id="search_department" class="form-select form-select-sm">
                                        <option value="" selected="">Department</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-xl-auto order-1 order-xl-2 mb-1 mb-xl-0">
                            <div class="row g-2 align-items-center justify-content-end">
                                <div class="col-auto">
                                    <button class="btn btn-falcon-default btn-sm d-xl-none" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#PolicyLogFilters"
                                        aria-expanded="false" aria-controls="PolicyLogFilters">
                                        <span class="fas fa-filter" data-fa-transform="shrink-3 down-2"></span>
                                    </button>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-dquam-success btn-sm" type="button"
                                        onclick="location.href='https://mgskw.sharepoint.com/sites/DQ/Pages/policy-request-new.aspx'">
                                        <span class="fas fa-plus" data-fa-transform="shrink-3 down-2"></span>
                                        <span class="d-none d-sm-inline-block ms-1">New</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- End: card-header -->
                <div class="card-body px-0 py-0">
                    <div class="table-responsive scrollbar">
                        <table class="table table-bordered table-striped fs--1 mb-0">
                            <thead class="bg-200 text-900">
                                <tr>
                                    <th class="sort" data-sort="id">Policy No.....</th>
                                    <th>Title</th>
                                    <th class="sort text-center" data-sort="stage">Stage</th>
                                    <th class="sort text-center" data-sort="status">Status</th>
                                    <th class="sort text-center" data-sort="dueDate">Due Date</th>
                                    <th class="sort text-center" data-sort="department">Department</th>
                                    <th class="sort text-center" data-sort="documentLink">Document Link</th>
                                    <th class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody class="list" id="tbl-policy-logs">

                            </tbody>
                        </table>
                    </div><!-- End: table-responsive -->
                </div><!-- End: card-body -->
                <div class="card-footer">
                    <div class="row align-items-center mt-3">
                        <div class="pagination d-none"></div>
                        <div class="col">
                            <p class="mb-0 fs--1">
                                <span class="d-none d-sm-inline-block" data-list-info="data-list-info"></span>
                                <span class="d-none d-sm-inline-block"> &mdash;</span>
                                <a class="fw-semi-bold text-info" href="#!" data-list-view="*">
                                    View all <span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span>
                                </a>
                                <a class="fw-semi-bold d-none" href="#!" data-list-view="less">
                                    View Less <span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span>
                                </a>
                            </p>
                        </div>
                        <div class="col-auto d-flex">
                            <button class="btn btn-sm btn-dquam-info" type="button" data-list-pagination="prev">
                                <span>Previous</span>
                            </button>
                            <button class="btn btn-sm btn-dquam-info px-4 ms-2" type="button"
                                data-list-pagination="next">
                                <span>Next</span>
                            </button>
                        </div>
                    </div>
                </div><!-- End: card-footer -->
            </div><!-- End: #tablePolicyLog -->

        </div><!-- End: content-inner -->

    </div><!-- End: content -->

</div><!-- End: container -->


<script type="text/javascript">

    let items = [];

    $(document).ready(function () {
        on_change_status();
        on_change_stage();
        on_change_department();


        modify_page_details();
        retrieve_table_data();
    });


    function modify_page_details() {
        $("#pageTitle").text('Policy Log');
    }

    async function retrieve_table_data() {
        items = await retrive_list_items();
        populate_table('#tbl-policy-logs', items);

    }

    async function retrive_list_items() {
        return new Promise(function (resolve, reject) {
            $.ajax({
                url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('Policy_List')/Items?$OrderBy=Modified desc",
                method: "GET",
                headers: {
                    "ACCEPT": "application/json; odata=verbose",
                },
                success: function (data) {
                    resolve(data.d.results);
                },
                error: function (error) {
                    reject(error);
                }
            });
        });
    }




    function populate_table(table_id, data) {
        html = '';
        if (data.length > 0) {
            $(data).each(function (index, value) {
                html += populate_table_row(value);
            });
        }
        $(table_id).html(html);
    }


    function populate_table_row(value) {
        return `
            <tr>
                <td class="id">${value.Sequence_Number}</td>
                <td>
                    <span class="d-inline-block text-truncate maxw-250" data-bs-toggle="tooltip" data-bs-placement="top" title="">
                        ${value.Request_title}
                    </span>
                </td>
                <td class="stage text-center">
                    <span>${value.Step_Stage}</span>
                </td>
                <td class="status text-center">
                    <span class="badge rounded badge-subtle-info p-2 minw-80">New</span>
                </td>
                <td class="dueDate text-center">${new Date(value.Submit_Date).format('yyyy/MM/dd')}</td>
                <td class="department text-center">${value.Department}</td>
                <td class="documentLink text-center">
                    <button class="btn btn-dquam-secondary btn-sm">
                        <span class="fas fa-file"></span>
                        View File
                    </button>
                </td>
                <td class="text-center">
                    <div class="btn-group font-sans-serif position-static">
                        <button class="btn btn-link btn-sm text-600 dropdown-toggle" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false">
                            <span class="fas fa-ellipsis-h fs--1"></span>
                        </button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="policy-request-readonly.html">View Details</a>
                            <a class="dropdown-item" href="policy-request-history.html">View History</a>
                            <a class="dropdown-item" href="request-meeting.html">Meeting Request</a>
                            <a class="dropdown-item" href="#">Open MS Teams</a>
                            <a class="dropdown-item" href="#">Dynamic Action</a>
                            <button class="dropdown-item text-danter" onclick="delete_record(${value.ID})">Delete</a>
                        </div>
                    </div>
                </td>
            </tr>`
    }



    function delete_record(record_id) {
        event.preventDefault();

        $.ajax({
            url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/lists/GetByTitle('Policy_List')/items(" + record_id + ")",
            type: "POST",
            async: false,
            headers: {
                "Accept": "application/json;odata=verbose",
                "X-Http-Method": "DELETE",
                "X-RequestDigest": $("#__REQUESTDIGEST").val(),
                "If-Match": "*"
            },
            success: function (data) {
                items = items.filter(item => item.ID !== record_id);
                populate_table('#tbl-policy-logs', items);
            },
            error: function (error) {
                console.log(JSON.stringify(error))
            }
        });
    }


    function on_change_status() {
        $('#search_status').on('change', function () {
            filter_table();
        });
    }
    
    
    function on_change_stage() {
        $('#search_stage').on('change', function () {
            filter_table();
        });
    }
    
    
    function on_change_department() {
        $('#search_department').on('change', function () {
            filter_table();
        });
    }

    function filter_table(){
        let search_status = $('#search_status').val();
        let search_stage = $('#search_stage').val();
        let search_department = $('#search_department').val();

        let filtered_items = items.filter(item => {
            return (
                (search_status === '' || item.Status == search_status) &&
                (search_stage === '' || item.Step_Stage == search_stage) &&
                (search_department === '' || item.Department == search_department)
            );
        });

        populate_table('#tbl-policy-logs', filtered_items);


    }

</script>